{% extends "base.html" %} {% block title %}Cache Management{% endblock %} {% block content %}
<div class="container-fluid">
  <h1 class="mt-4 mb-4">Cache Management</h1>

  <div class="row">
    <!-- Cache Overview Card -->
    <div class="col-md-12">
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">Cache Overview</h5>
          <div>
            <form method="post" action="{{ url_for('performance.cache_clear') }}" class="d-inline">
              <button type="submit" class="btn btn-sm btn-warning">
                <i class="fas fa-trash-alt"></i> Clear All Caches
              </button>
            </form>
          </div>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3 text-center">
              <h5>Hit Rate</h5>
              <div class="display-4 text-{{ cache_stats.hit_rate_color }}">
                {{ cache_stats.hit_rate|round(1) }}%
              </div>
              <div class="progress mt-2">
                <div
                  class="progress-bar bg-{{ cache_stats.hit_rate_color }}"
                  role="progressbar"
                  style="width: {{ cache_stats.hit_rate }}%"
                  aria-valuenow="{{ cache_stats.hit_rate }}"
                  aria-valuemin="0"
                  aria-valuemax="100"
                ></div>
              </div>
            </div>
            <div class="col-md-3 text-center">
              <h5>Memory Usage</h5>
              <div class="display-4 text-{{ cache_stats.memory_color }}">
                {{ cache_stats.memory_usage_mb|round(1) }}
                <small>MB</small>
              </div>
              <div class="progress mt-2">
                <div
                  class="progress-bar bg-{{ cache_stats.memory_color }}"
                  role="progressbar"
                  style="width: {{ cache_stats.memory_percent }}%"
                  aria-valuenow="{{ cache_stats.memory_percent }}"
                  aria-valuemin="0"
                  aria-valuemax="100"
                ></div>
              </div>
            </div>
            <div class="col-md-3 text-center">
              <h5>Cached Items</h5>
              <div class="display-4">{{ cache_stats.total_items }}</div>
              <p>Avg Size: {{ cache_stats.avg_item_size_kb|round(2) }} KB</p>
            </div>
            <div class="col-md-3 text-center">
              <h5>Performance Gain</h5>
              <div class="display-4 text-success">{{ cache_stats.performance_gain|round(1) }}x</div>
              <p>{{ cache_stats.time_saved|round(2) }}s saved</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Cache Statistics Chart -->
    <div class="col-md-8">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0">Cache Performance History</h5>
        </div>
        <div class="card-body">
          <ul class="nav nav-tabs" id="cacheChartTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button
                class="nav-link active"
                id="hit-rate-tab"
                data-bs-toggle="tab"
                data-bs-target="#hit-rate"
                type="button"
                role="tab"
                aria-controls="hit-rate"
                aria-selected="true"
              >
                Hit Rate
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button
                class="nav-link"
                id="response-time-tab"
                data-bs-toggle="tab"
                data-bs-target="#response-time"
                type="button"
                role="tab"
                aria-controls="response-time"
                aria-selected="false"
              >
                Response Time
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button
                class="nav-link"
                id="memory-usage-tab"
                data-bs-toggle="tab"
                data-bs-target="#memory-usage"
                type="button"
                role="tab"
                aria-controls="memory-usage"
                aria-selected="false"
              >
                Memory Usage
              </button>
            </li>
          </ul>
          <div class="tab-content mt-3" id="cacheChartTabsContent">
            <div
              class="tab-pane fade show active"
              id="hit-rate"
              role="tabpanel"
              aria-labelledby="hit-rate-tab"
            >
              <canvas id="hitRateChart" width="100%" height="300"></canvas>
            </div>
            <div
              class="tab-pane fade"
              id="response-time"
              role="tabpanel"
              aria-labelledby="response-time-tab"
            >
              <canvas id="responseTimeChart" width="100%" height="300"></canvas>
            </div>
            <div
              class="tab-pane fade"
              id="memory-usage"
              role="tabpanel"
              aria-labelledby="memory-usage-tab"
            >
              <canvas id="memoryUsageChart" width="100%" height="300"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Cache Configuration -->
    <div class="col-md-4">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0">Cache Configuration</h5>
        </div>
        <div class="card-body">
          <form method="post" action="{{ url_for('performance.cache_resize') }}">
            <div class="mb-3">
              <label for="cacheSize" class="form-label">Maximum Cache Size (MB)</label>
              <input
                type="number"
                class="form-control"
                id="cacheSize"
                name="size"
                value="{{ cache_stats.max_size_mb }}"
                min="1"
                max="2048"
              />
              <div class="form-text">Maximum memory allowed for caching</div>
            </div>
            <div class="mb-3">
              <label for="cacheTTL" class="form-label">Default TTL (seconds)</label>
              <input
                type="number"
                class="form-control"
                id="cacheTTL"
                name="ttl"
                value="{{ cache_stats.default_ttl }}"
                min="1"
                max="86400"
              />
              <div class="form-text">Default time-to-live for cached items</div>
            </div>
            <div class="mb-3">
              <label for="evictionPolicy" class="form-label">Eviction Policy</label>
              <select class="form-select" id="evictionPolicy" name="eviction_policy">
                <option
                  value="LRU"
                  {%
                  if
                  cache_stats.eviction_policy=""
                  ="LRU"
                  %}selected{%
                  endif
                  %}
                >
                  Least Recently Used (LRU)
                </option>
                <option
                  value="LFU"
                  {%
                  if
                  cache_stats.eviction_policy=""
                  ="LFU"
                  %}selected{%
                  endif
                  %}
                >
                  Least Frequently Used (LFU)
                </option>
                <option
                  value="FIFO"
                  {%
                  if
                  cache_stats.eviction_policy=""
                  ="FIFO"
                  %}selected{%
                  endif
                  %}
                >
                  First In First Out (FIFO)
                </option>
              </select>
              <div class="form-text">Strategy for removing items when cache is full</div>
            </div>
            <div class="form-check mb-3">
              <input
                class="form-check-input"
                type="checkbox"
                id="enableCompression"
                name="compression"
                {%
                if
                cache_stats.compression_enabled
                %}checked{%
                endif
                %}
              />
              <label class="form-check-label" for="enableCompression"> Enable Compression </label>
              <div class="form-text">
                Compress cached items to save memory (slight CPU overhead)
              </div>
            </div>
            <button type="submit" class="btn btn-primary">Update Configuration</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Cache Types -->
    <div class="col-md-12">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0">Cache Types</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>Cache Type</th>
                  <th>Items</th>
                  <th>Memory Usage</th>
                  <th>Hit Rate</th>
                  <th>Avg TTL</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for cache in cache_stats.caches %}
                <tr>
                  <td>{{ cache.name }}</td>
                  <td>{{ cache.items }}</td>
                  <td>{{ cache.memory_mb|round(2) }} MB</td>
                  <td>
                    <div class="progress">
                      <div
                        class="progress-bar bg-{{ cache.hit_rate_color }}"
                        role="progressbar"
                        style="width: {{ cache.hit_rate }}%"
                        aria-valuenow="{{ cache.hit_rate }}"
                        aria-valuemin="0"
                        aria-valuemax="100"
                      >
                        {{ cache.hit_rate|round(1) }}%
                      </div>
                    </div>
                  </td>
                  <td>{{ cache.avg_ttl }} sec</td>
                  <td>
                    <span class="badge bg-{{ cache.status_color }}">{{ cache.status }}</span>
                  </td>
                  <td>
                    <form
                      method="post"
                      action="{{ url_for('performance.cache_clear_type') }}"
                      class="d-inline"
                    >
                      <input type="hidden" name="cache_type" value="{{ cache.name }}" />
                      <button type="submit" class="btn btn-sm btn-outline-danger">Clear</button>
                    </form>
                    <button
                      class="btn btn-sm btn-outline-primary"
                      data-bs-toggle="modal"
                      data-bs-target="#cacheConfigModal"
                      data-cache-name="{{ cache.name }}"
                      data-cache-ttl="{{ cache.ttl }}"
                      data-cache-max-size="{{ cache.max_size_mb }}"
                    >
                      Configure
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Top Cached Items -->
    <div class="col-md-12">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0">Top Cached Items</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Key</th>
                  <th>Type</th>
                  <th>Size</th>
                  <th>Hits</th>
                  <th>TTL</th>
                  <th>Last Access</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for item in cache_stats.top_items %}
                <tr>
                  <td><code>{{ item.key }}</code></td>
                  <td>{{ item.type }}</td>
                  <td>{{ item.size_kb|round(2) }} KB</td>
                  <td>{{ item.hits }}</td>
                  <td>{{ item.ttl_remaining }} sec</td>
                  <td>{{ item.last_access }}</td>
                  <td>
                    <form
                      method="post"
                      action="{{ url_for('performance.cache_invalidate_key') }}"
                      class="d-inline"
                    >
                      <input type="hidden" name="cache_key" value="{{ item.key }}" />
                      <input type="hidden" name="cache_type" value="{{ item.type }}" />
                      <button type="submit" class="btn btn-sm btn-outline-danger">
                        Invalidate
                      </button>
                    </form>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Performance Options -->
    <div class="col-md-12">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0">Performance Options</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3 text-center mb-3">
              <a href="{{ url_for('performance.dashboard') }}" class="btn btn-primary btn-lg w-100">
                <i class="fas fa-chart-line mb-2"></i><br />
                Dashboard
              </a>
            </div>
            <div class="col-md-3 text-center mb-3">
              <a href="{{ url_for('performance.details') }}" class="btn btn-info btn-lg w-100">
                <i class="fas fa-tachometer-alt mb-2"></i><br />
                Performance Details
              </a>
            </div>
            <div class="col-md-3 text-center mb-3">
              <a href="{{ url_for('performance.memory') }}" class="btn btn-success btn-lg w-100">
                <i class="fas fa-memory mb-2"></i><br />
                Memory Optimization
              </a>
            </div>
            <div class="col-md-3 text-center mb-3">
              <a href="{{ url_for('performance.settings') }}" class="btn btn-warning btn-lg w-100">
                <i class="fas fa-cogs mb-2"></i><br />
                Optimization Settings
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Cache Config Modal -->
<div
  class="modal fade"
  id="cacheConfigModal"
  tabindex="-1"
  aria-labelledby="cacheConfigModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cacheConfigModalLabel">Configure Cache</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form method="post" action="{{ url_for('performance.cache_configure_type') }}">
          <input type="hidden" id="cacheName" name="cache_type" />
          <div class="mb-3">
            <label for="cacheTypeTTL" class="form-label">TTL (seconds)</label>
            <input
              type="number"
              class="form-control"
              id="cacheTypeTTL"
              name="ttl"
              min="1"
              max="86400"
            />
            <div class="form-text">Time-to-live for items in this cache</div>
          </div>
          <div class="mb-3">
            <label for="cacheTypeSize" class="form-label">Maximum Size (MB)</label>
            <input
              type="number"
              class="form-control"
              id="cacheTypeSize"
              name="max_size"
              min="1"
              max="1024"
            />
            <div class="form-text">Maximum memory allowed for this cache type</div>
          </div>
          <div class="form-check mb-3">
            <input
              class="form-check-input"
              type="checkbox"
              id="cacheTypeEnabled"
              name="enabled"
              checked
            />
            <label class="form-check-label" for="cacheTypeEnabled"> Enabled </label>
            <div class="form-text">Enable or disable this cache type</div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Configuration</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Hit Rate Chart
  var hitRateCtx = document.getElementById('hitRateChart').getContext('2d');
  var hitRateChart = new Chart(hitRateCtx, {
      type: 'line',
      data: {
          labels: {{ cache_stats.time_labels|tojson }},
          datasets: [
              {
                  label: 'Hit Rate (%)',
                  data: {{ cache_stats.hit_rate_history|tojson }},
                  backgroundColor: 'rgba(75, 192, 192, 0.2)',
                  borderColor: 'rgba(75, 192, 192, 1)',
                  borderWidth: 1,
                  tension: 0.4
              }
          ]
      },
      options: {
          responsive: true,
          scales: {
              y: {
                  beginAtZero: true,
                  max: 100,
                  title: {
                      display: true,
                      text: 'Hit Rate (%)'
                  }
              },
              x: {
                  title: {
                      display: true,
                      text: 'Time'
                  }
              }
          }
      }
  });

  // Response Time Chart
  var responseTimeCtx = document.getElementById('responseTimeChart').getContext('2d');
  var responseTimeChart = new Chart(responseTimeCtx, {
      type: 'line',
      data: {
          labels: {{ cache_stats.time_labels|tojson }},
          datasets: [
              {
                  label: 'With Cache (ms)',
                  data: {{ cache_stats.cached_time_history|tojson }},
                  backgroundColor: 'rgba(54, 162, 235, 0.2)',
                  borderColor: 'rgba(54, 162, 235, 1)',
                  borderWidth: 1,
                  tension: 0.4
              },
              {
                  label: 'Without Cache (ms)',
                  data: {{ cache_stats.uncached_time_history|tojson }},
                  backgroundColor: 'rgba(255, 99, 132, 0.2)',
                  borderColor: 'rgba(255, 99, 132, 1)',
                  borderWidth: 1,
                  tension: 0.4
              }
          ]
      },
      options: {
          responsive: true,
          scales: {
              y: {
                  beginAtZero: true,
                  title: {
                      display: true,
                      text: 'Response Time (ms)'
                  }
              },
              x: {
                  title: {
                      display: true,
                      text: 'Time'
                  }
              }
          }
      }
  });

  // Memory Usage Chart
  var memoryUsageCtx = document.getElementById('memoryUsageChart').getContext('2d');
  var memoryUsageChart = new Chart(memoryUsageCtx, {
      type: 'line',
      data: {
          labels: {{ cache_stats.time_labels|tojson }},
          datasets: [
              {
                  label: 'Memory Usage (MB)',
                  data: {{ cache_stats.memory_history|tojson }},
                  backgroundColor: 'rgba(153, 102, 255, 0.2)',
                  borderColor: 'rgba(153, 102, 255, 1)',
                  borderWidth: 1,
                  tension: 0.4
              }
          ]
      },
      options: {
          responsive: true,
          scales: {
              y: {
                  beginAtZero: true,
                  title: {
                      display: true,
                      text: 'Memory (MB)'
                  }
              },
              x: {
                  title: {
                      display: true,
                      text: 'Time'
                  }
              }
          }
      }
  });

  // Handle Cache Config Modal
  var cacheConfigModal = document.getElementById('cacheConfigModal')
  cacheConfigModal.addEventListener('show.bs.modal', function (event) {
      var button = event.relatedTarget
      var cacheName = button.getAttribute('data-cache-name')
      var cacheTTL = button.getAttribute('data-cache-ttl')
      var cacheMaxSize = button.getAttribute('data-cache-max-size')

      var cacheNameInput = document.getElementById('cacheName')
      var cacheTTLInput = document.getElementById('cacheTypeTTL')
      var cacheMaxSizeInput = document.getElementById('cacheTypeSize')

      cacheNameInput.value = cacheName
      cacheTTLInput.value = cacheTTL
      cacheMaxSizeInput.value = cacheMaxSize

      var modalTitle = cacheConfigModal.querySelector('.modal-title')
      modalTitle.textContent = 'Configure ' + cacheName + ' Cache'
  });

  // Auto-refresh every 2 minutes
  setTimeout(function() {
      location.reload();
  }, 120000);
</script>
{% endblock %}
